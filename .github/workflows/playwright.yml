name: Playwright Tests

on:
  workflow_dispatch:
    inputs:
      group:
        description: "Spec group to run"
        type: choice
        required: false
        default: all
        options: [all, web, api, mixed]
      browser:
        description: "Browser to run"
        type: choice
        required: false
        default: all
        options: [all, chromium, firefox, webkit]
      tags:
        description: "Playwright grep, e.g. @smoke or @api"
        type: string
        required: false
        default: ""
      data_source:
        description: "Test data source"
        type: choice
        required: false
        default: json
        options: [json, yaml, excel, fixture]
      pwdebug:
        description: "Enable PWDEBUG=1"
        type: boolean
        required: false
        default: false
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        group: [web, api, mixed]
        browser: [chromium, firefox, webkit]
        exclude:
          - group: api
            browser: firefox
          - group: api
            browser: webkit
          - group: mixed
            browser: webkit

    env:
      # Inputs (when workflow_dispatch) override repo-level variables
      GOREST_TOKEN: ${{ secrets.API_TOKEN }}
      DATA_SOURCE: ${{ github.event.inputs.data_source || vars.DATA_SOURCE || 'json' }}
      TAGS: ${{ github.event.inputs.tags || vars.TAGS }}
      PWDEBUG: ${{ github.event.inputs.pwdebug == 'true' && '1' || '' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      # Cache Playwright browsers so they aren't reinstalled every run
      - name: Resolve Playwright version
        id: pw
        shell: bash
        run: |
          node -e "console.log('version=' + require('@playwright/test/package.json').version)" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        id: cache-browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ steps.pw.outputs.version }}

      - name: Install Playwright browsers (only if cache miss)
        if: steps.cache-browsers.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

      # Run only when inputs match this matrix entry, or when not manually dispatched
      - name: Run ${{ matrix.group }} specs on ${{ matrix.browser }} (visuals skipped on CI)
        shell: bash
        run: |
          set -e

          # Dispatcher filtering: run only selected group/browser if provided
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SEL_GROUP="${{ github.event.inputs.group || 'all' }}"
            SEL_BROWSER="${{ github.event.inputs.browser || 'all' }}"
            [[ "$SEL_GROUP" != "all" && "$SEL_GROUP" != "${{ matrix.group }}" ]] && { echo "Skipping: group filter"; exit 0; }
            [[ "$SEL_BROWSER" != "all" && "$SEL_BROWSER" != "${{ matrix.browser }}" ]] && { echo "Skipping: browser filter"; exit 0; }
          fi

          # Always skip visual tests on CI via invert grep (@visual)
          SKIP_VISUAL="--grep-invert @visual"

          if [[ -n "${TAGS}" ]]; then
            # If user passed TAGS, combine with visual exclusion
            npx playwright test "src/tests/${{ matrix.group }}" \
              --config=playwright.ci.config.ts \
              --project="${{ matrix.browser }}" \
              ${SKIP_VISUAL} \
              --grep "${TAGS}"
          else
            npx playwright test "src/tests/${{ matrix.group }}" \
              --config=playwright.ci.config.ts \
              --project="${{ matrix.browser }}" \
              ${SKIP_VISUAL}
          fi

      - name: Upload HTML report (${{ matrix.group }} - ${{ matrix.browser }})
        if: ${{ always() && ( github.event_name != 'workflow_dispatch' || (
                (github.event.inputs.group == '' || github.event.inputs.group == 'all' || matrix.group == github.event.inputs.group) &&
                (github.event.inputs.browser == '' || github.event.inputs.browser == 'all' || matrix.browser == github.event.inputs.browser)
              )) }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.group }}-${{ matrix.browser }}
          path: playwright-report

      - name: Upload Allure results (${{ matrix.group }} - ${{ matrix.browser }})
        if: ${{ always() && ( github.event_name != 'workflow_dispatch' || (
                (github.event.inputs.group == '' || github.event.inputs.group == 'all' || matrix.group == github.event.inputs.group) &&
                (github.event.inputs.browser == '' || github.event.inputs.browser == 'all' || matrix.browser == github.event.inputs.browser)
              )) }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.group }}-${{ matrix.browser }}
          path: allure-results